<html lang="en" style="height: 100%">

<script src="//maps.google.com/maps/api/js?v=3.22&libraries=geometry" type="text/javascript"></script>
<script src="//google-maps-utility-library-v3.googlecode.com/svn/tags/markerclustererplus/2.0.14/src/markerclusterer_packed.js" type="text/javascript"></script>

<body style="height: 100%; margin: 0">
<div style='width: 100%; height: 100%;'>
  <div id="map" style='width: 100%; height: 100%;'></div>
</div>

<script type="text/javascript">
  var anumber = 1
  var handler = Gmaps.build('Google');
     handler.buildMap({ internal: {id: 'map'}}, function(){
       var plan = <%= raw @result %>;
       plan.options = {
         geodesic: true,
         strokeColor: '#FF0000',
         strokeOpacity: 1.0,
         strokeWeight: 4,
         title: 'plan'
       };


       function addPolyline(polyline){
         var transformedPolyline = _.map(polyline, function(coordinates){
           return { lat: coordinates[0], lng: coordinates[1] };
         })
         handler.addPolyline(transformedPolyline, polyline.options);
         handler.bounds.extend(transformedPolyline[0]);
         handler.bounds.extend(polyline[ polyline.length - 1]);
       }
       
       if(navigator.geolocation)
          navigator.geolocation.getCurrentPosition(displayOnMap,function error(msg){alert('Please enable your GPS position future.');
}, {maximumAge:600000, timeout:8000, enableHighAccuracy: true});

       addPolyline(plan);
       handler.fitMapToBounds();
     });
     
     function displayOnMap(position){
       var marker = handler.addMarker({
         lat: position.coords.latitude,
         lng: position.coords.longitude
       });
       handler.map.centerOn(marker);
     };
</script>
</body>
</html>
